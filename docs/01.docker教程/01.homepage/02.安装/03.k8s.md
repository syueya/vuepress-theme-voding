---
title: k8s
permalink: /docker/homepage/install/k8s
date: 2023-10-24 14:23:11
categories: 
  - dockeræ•™ç¨‹
  - homepage
  - å®‰è£…
tags: 
  - 
---

## ä½¿ç”¨Helmå®‰è£…

æœ‰ä¸€ä¸ªéå®˜æ–¹çš„ [Helm Chart](https://github.com/jameswynn/helm-charts/tree/main/charts/homepage)ï¼Œå®ƒå¯ä»¥åˆ›å»ºæ‰€æœ‰å¿…éœ€çš„æ¸…å•æ–‡ä»¶ï¼ŒåŒ…æ‹¬ç”¨äºæœåŠ¡å‘ç°æ‰€éœ€çš„æœåŠ¡è´¦å·å’Œ RBAC å®ä½“ã€‚

```sh
helm repo add jameswynn https://jameswynn.github.io/helm-charts
helm install 01.homepage jameswynn/01.homepage -f values.yaml
```
è¿™ä¸ª Helm Chart å…è®¸å°†æ‰€æœ‰çš„é…ç½®ç›´æ¥å†…åµŒåœ¨`values.yaml`æ–‡ä»¶ä¸­ã€‚

```yaml
config:
    bookmarks:
        - Developer:
              - Github:
                    - abbr: GH
                      href: https://github.com/
    services:
        - My First Group:
              - My First Service:
                    href: http://localhost/
                    description: Homepage is awesome

        - My Second Group:
              - My Second Service:
                    href: http://localhost/
                    description: Homepage is the best

        - My Third Group:
              - My Third Service:
                    href: http://localhost/
                    description: Homepage is ğŸ˜
    widgets:
        # show the kubernetes widget, with the cluster summary and individual nodes
        - kubernetes:
              cluster:
                  show: true
                  cpu: true
                  memory: true
                  showLabel: true
                  label: "cluster"
              nodes:
                  show: true
                  cpu: true
                  memory: true
                  showLabel: true
        - search:
              provider: duckduckgo
              target: _blank
    kubernetes:
        mode: cluster
    settings:

# The service account is necessary to allow discovery of other services
serviceAccount:
    create: true
    name: 01.homepage

# This enables the service account to access the necessary resources
enableRbac: true

ingress:
    main:
        enabled: true
        annotations:
            # Example annotations to add Homepage to your Homepage!
            gethomepage.dev/enabled: "true"
            gethomepage.dev/name: "Homepage"
            gethomepage.dev/description: "Dynamically Detected Homepage"
            gethomepage.dev/group: "Dynamic"
            gethomepage.dev/icon: "01.homepage.png"
        hosts:
            - host: 01.homepage.example.com
              paths:
                  - path: /
                    pathType: Prefix
```

## ä½¿ç”¨Kubernetes Manifestså®‰è£…

å¦‚æœæ‚¨ä¸æƒ³ä½¿ç”¨éå®˜æ–¹çš„ Helm Chartï¼Œæ‚¨ä¹Ÿå¯ä»¥è‡ªå·±åˆ›å»º Kubernetes æ¸…å•æ–‡ä»¶ï¼Œå¹¶ä½¿ç”¨ kubectl apply -f filename.yaml å‘½ä»¤åº”ç”¨å®ƒä»¬ã€‚

ä¸‹é¢æ˜¯ä¸€ä¸ªç¤ºä¾‹ï¼Œå±•ç¤ºäº†æ‚¨æ‰€éœ€çš„èµ„æºçš„å·¥ä½œæ–¹å¼ï¼š

#### æœåŠ¡è´¦å· ServiceAccount

```yaml
apiVersion: v1
kind: ServiceAccount
metadata:
    name: 01.homepage
    namespace: default
    labels:
        app.kubernetes.io/name: 01.homepage
secrets:
    - name: 01.homepage
```

#### Secret

```yaml
apiVersion: v1
kind: Secret
type: kubernetes.io/service-account-token
metadata:
    name: 01.homepage
    namespace: default
    labels:
        app.kubernetes.io/name: 01.homepage
    annotations:
        kubernetes.io/service-account.name: 01.homepage
```

#### é…ç½®æ˜ å°„ ConfigMap

```yaml
apiVersion: v1
kind: ConfigMap
metadata:
    name: 01.homepage
    namespace: default
    labels:
        app.kubernetes.io/name: 01.homepage
data:
    kubernetes.yaml: |
        mode: cluster
    settings.yaml: ""
    #settings.yaml: |
    #  providers:
    #    longhorn:
    #      url: https://longhorn.my.network
    custom.css: ""
    custom.js: ""
    bookmarks.yaml: |
        - Developer:
            - Github:
                - abbr: GH
                  href: https://github.com/
    services.yaml: |
        - My First Group:
            - My First Service:
                href: http://localhost/
                description: Homepage is awesome

        - My Second Group:
            - My Second Service:
                href: http://localhost/
                description: Homepage is the best

        - My Third Group:
            - My Third Service:
                href: http://localhost/
                description: Homepage is ğŸ˜
    widgets.yaml: |
        - kubernetes:
            cluster:
              show: true
              cpu: true
              memory: true
              showLabel: true
              label: "cluster"
            nodes:
              show: true
              cpu: true
              memory: true
              showLabel: true
        - resources:
            backend: resources
            expanded: true
            cpu: true
            memory: true
        - search:
            provider: duckduckgo
            target: _blank
    docker.yaml: ""
```

#### é›†ç¾¤è§’è‰²å’Œé›†ç¾¤è§’è‰²ç»‘å®š ClusterRole and ClusterRoleBinding

```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
    name: 01.homepage
    labels:
        app.kubernetes.io/name: 01.homepage
rules:
    - apiGroups:
          - ""
      resources:
          - namespaces
          - pods
          - nodes
      verbs:
          - get
          - list
    - apiGroups:
          - extensions
          - networking.k8s.io
      resources:
          - ingresses
      verbs:
          - get
          - list
    - apiGroups:
          - traefik.containo.us
      resources:
          - ingressroutes
      verbs:
          - get
          - list
    - apiGroups:
          - metrics.k8s.io
      resources:
          - nodes
          - pods
      verbs:
          - get
          - list
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
    name: 01.homepage
    labels:
        app.kubernetes.io/name: 01.homepage
roleRef:
    apiGroup: rbac.authorization.k8s.io
    kind: ClusterRole
    name: 01.homepage
subjects:
    - kind: ServiceAccount
      name: 01.homepage
      namespace: default
```

#### Service

```yaml
apiVersion: v1
kind: Service
metadata:
    name: 01.homepage
    namespace: default
    labels:
        app.kubernetes.io/name: 01.homepage
    annotations:
spec:
    type: ClusterIP
    ports:
        - port: 3000
          targetPort: http
          protocol: TCP
          name: http
    selector:
        app.kubernetes.io/name: 01.homepage
```

#### éƒ¨ç½² Deployment

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
    name: 01.homepage
    namespace: default
    labels:
        app.kubernetes.io/name: 01.homepage
spec:
    revisionHistoryLimit: 3
    replicas: 1
    strategy:
        type: RollingUpdate
    selector:
        matchLabels:
            app.kubernetes.io/name: 01.homepage
    template:
        metadata:
            labels:
                app.kubernetes.io/name: 01.homepage
        spec:
            serviceAccountName: 01.homepage
            automountServiceAccountToken: true
            dnsPolicy: ClusterFirst
            enableServiceLinks: true
            containers:
                - name: 01.homepage
                  image: "ghcr.io/gethomepage/01.homepage:latest"
                  imagePullPolicy: Always
                  ports:
                      - name: http
                        containerPort: 3000
                        protocol: TCP
                  volumeMounts:
                      - mountPath: /app/config/custom.js
                        name: 01.homepage-config
                        subPath: custom.js
                      - mountPath: /app/config/custom.css
                        name: 01.homepage-config
                        subPath: custom.css
                      - mountPath: /app/config/bookmarks.yaml
                        name: 01.homepage-config
                        subPath: bookmarks.yaml
                      - mountPath: /app/config/docker.yaml
                        name: 01.homepage-config
                        subPath: docker.yaml
                      - mountPath: /app/config/kubernetes.yaml
                        name: 01.homepage-config
                        subPath: kubernetes.yaml
                      - mountPath: /app/config/services.yaml
                        name: 01.homepage-config
                        subPath: services.yaml
                      - mountPath: /app/config/settings.yaml
                        name: 01.homepage-config
                        subPath: settings.yaml
                      - mountPath: /app/config/widgets.yaml
                        name: 01.homepage-config
                        subPath: widgets.yaml
                      - mountPath: /app/config/logs
                        name: logs
            volumes:
                - name: 01.homepage-config
                  configMap:
                      name: 01.homepage
                - name: logs
                  emptyDir: {}
```

#### Ingress

```yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
    name: 01.homepage
    namespace: default
    labels:
        app.kubernetes.io/name: 01.homepage
    annotations:
        gethomepage.dev/description: Dynamically Detected Homepage
        gethomepage.dev/enabled: "true"
        gethomepage.dev/group: Cluster Management
        gethomepage.dev/icon: 01.homepage.png
        gethomepage.dev/name: Homepage
spec:
    rules:
        - host: "01.homepage.my.network"
          http:
              paths:
                  - path: "/"
                    pathType: Prefix
                    backend:
                        service:
                            name: 01.homepage
                            port:
                                number: 3000
```
